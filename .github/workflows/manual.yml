name: Build and Upload AIoT Model

on:
  push:
    branches: [main]

jobs:
  build-aiot:
    runs-on: ubuntu-latest

    env:
      EI_API_KEY: ${{ secrets.EI_API_KEY }}
      EI_PROJECT_ID: 749177
      HF_TOKEN: ${{ secrets.HUGGING_FACE_TOKEN }}
      HF_REPO: nghes/ei-models

    steps:
      - name: ðŸ§° Set up QEMU for ARM emulation
        uses: docker/setup-qemu-action@v3

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”„ Checkout repository
        uses: actions/checkout@v3

      - name: ðŸ“¦ Install dependencies
        run: sudo apt-get update && sudo apt-get install -y unzip curl git-lfs

      - name: ðŸ“¥ Download and unzip Edge Impulse model
        run: |
          curl -L \
            --url "https://studio.edgeimpulse.com/v1/api/${EI_PROJECT_ID}/deployment/download?type=zip&impulse=14" \
            --header "x-api-key: ${EI_API_KEY}" \
            --header "Accept: */*" \
            --output model.zip && unzip -o model.zip -d model/

      - name: ðŸ“‚ Copy model files to project root
        run: |
          cp -r model/model-parameters ./model-parameters
          cp -r model/tflite-model ./tflite-model

      - name: ðŸ›  Run build script using ARM64 container
        run: |
          git config --global --add safe.directory /opt/esp/idf/components/openthread/openthread
          chmod +x ./build.sh
          ./build.sh

      - name: ðŸ“¤ Push aiot-bin.bin to Hugging Face Hub
        env:
          HF_HOME: /tmp
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          git clone https://huggingface.co/${HF_REPO} hf-repo
          cp aiot-bin.bin hf-repo/
          
          # Get original commit message
          COMMIT_MSG=$(git log -1 --pretty=%B)
      
          cd hf-repo
          git add aiot-bin.bin
          git commit -m "$COMMIT_MSG"
          git push https://huggingface.co/${HF_REPO} > /dev/null 2>&1